    global
        lua-load /etc/haproxy/random-redirect.lua
        log stdout format raw local0 debug
        crt-base /etc/grid-security/certificates

        maxconn     4000
        user        haproxy
        group       haproxy
        #daemon

        stats socket /var/lib/haproxy/stats

    defaults
        mode                    http
        log                     global
        option                  httplog
        option                  dontlognull
        option http-server-close
        option forwardfor       except 127.0.0.0/8
        option                  redispatch
        retries                 3
        timeout http-request    10s
        timeout queue           1m
        timeout connect         10s
        timeout client          1m
        timeout server          1m
        timeout http-keep-alive 10s
        timeout check           10s
        maxconn                 3000

    listen stats
        bind :::1024 ssl  crt /usr/local/etc/haproxy/certs/cert.pem ssl-min-ver TLSv1.2
        mode http
        stats enable
        stats hide-version
        stats uri /haproxy_stats
        stats realm HAProxy\ Statistics



frontend range-f011
    bind 2001:48d0:6020:f011::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f011)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f011
        mode http
        option tcp-check
        server dtn-f011-02.t2.ucsd.edu:1094 dtn-f011-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f011-03.t2.ucsd.edu:1094 dtn-f011-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f011-04.t2.ucsd.edu:1094 dtn-f011-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f011-05.t2.ucsd.edu:1094 dtn-f011-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f011-06.t2.ucsd.edu:1094 dtn-f011-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f011-07.t2.ucsd.edu:1094 dtn-f011-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f011-08.t2.ucsd.edu:1094 dtn-f011-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f012
    bind 2001:48d0:6020:f012::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f012)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f012
        mode http
        option tcp-check
        server dtn-f012-02.t2.ucsd.edu:1094 dtn-f012-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f012-03.t2.ucsd.edu:1094 dtn-f012-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f012-04.t2.ucsd.edu:1094 dtn-f012-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f012-05.t2.ucsd.edu:1094 dtn-f012-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f012-06.t2.ucsd.edu:1094 dtn-f012-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f012-07.t2.ucsd.edu:1094 dtn-f012-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f012-08.t2.ucsd.edu:1094 dtn-f012-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f013
    bind 2001:48d0:6020:f013::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f013)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f013
        mode http
        option tcp-check
        server dtn-f013-02.t2.ucsd.edu:1094 dtn-f013-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f013-03.t2.ucsd.edu:1094 dtn-f013-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f013-04.t2.ucsd.edu:1094 dtn-f013-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f013-05.t2.ucsd.edu:1094 dtn-f013-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f013-06.t2.ucsd.edu:1094 dtn-f013-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f013-07.t2.ucsd.edu:1094 dtn-f013-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f013-08.t2.ucsd.edu:1094 dtn-f013-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f014
    bind 2001:48d0:6020:f014::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f014)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f014
        mode http
        option tcp-check
        server dtn-f014-02.t2.ucsd.edu:1094 dtn-f014-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f014-03.t2.ucsd.edu:1094 dtn-f014-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f014-04.t2.ucsd.edu:1094 dtn-f014-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f014-05.t2.ucsd.edu:1094 dtn-f014-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f014-06.t2.ucsd.edu:1094 dtn-f014-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f014-07.t2.ucsd.edu:1094 dtn-f014-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f014-08.t2.ucsd.edu:1094 dtn-f014-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f015
    bind 2001:48d0:6020:f015::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f015)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f015
        mode http
        option tcp-check
        server dtn-f015-02.t2.ucsd.edu:1094 dtn-f015-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f015-03.t2.ucsd.edu:1094 dtn-f015-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f015-04.t2.ucsd.edu:1094 dtn-f015-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f015-05.t2.ucsd.edu:1094 dtn-f015-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f015-06.t2.ucsd.edu:1094 dtn-f015-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f015-07.t2.ucsd.edu:1094 dtn-f015-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f015-08.t2.ucsd.edu:1094 dtn-f015-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f016
    bind 2001:48d0:6020:f016::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f016)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f016
        mode http
        option tcp-check
        server dtn-f016-02.t2.ucsd.edu:1094 dtn-f016-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f016-03.t2.ucsd.edu:1094 dtn-f016-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f016-04.t2.ucsd.edu:1094 dtn-f016-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f016-05.t2.ucsd.edu:1094 dtn-f016-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f016-06.t2.ucsd.edu:1094 dtn-f016-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f016-07.t2.ucsd.edu:1094 dtn-f016-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f016-08.t2.ucsd.edu:1094 dtn-f016-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f017
    bind 2001:48d0:6020:f017::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f017)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f017
        mode http
        option tcp-check
        server dtn-f017-02.t2.ucsd.edu:1094 dtn-f017-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f017-03.t2.ucsd.edu:1094 dtn-f017-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f017-04.t2.ucsd.edu:1094 dtn-f017-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f017-05.t2.ucsd.edu:1094 dtn-f017-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f017-06.t2.ucsd.edu:1094 dtn-f017-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f017-07.t2.ucsd.edu:1094 dtn-f017-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f017-08.t2.ucsd.edu:1094 dtn-f017-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f018
    bind 2001:48d0:6020:f018::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f018)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f018
        mode http
        option tcp-check
        server dtn-f018-02.t2.ucsd.edu:1094 dtn-f018-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f018-03.t2.ucsd.edu:1094 dtn-f018-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f018-04.t2.ucsd.edu:1094 dtn-f018-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f018-05.t2.ucsd.edu:1094 dtn-f018-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f018-06.t2.ucsd.edu:1094 dtn-f018-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f018-07.t2.ucsd.edu:1094 dtn-f018-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f018-08.t2.ucsd.edu:1094 dtn-f018-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f019
    bind 2001:48d0:6020:f019::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f019)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f019
        mode http
        option tcp-check
        server dtn-f019-02.t2.ucsd.edu:1094 dtn-f019-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f019-03.t2.ucsd.edu:1094 dtn-f019-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f019-04.t2.ucsd.edu:1094 dtn-f019-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f019-05.t2.ucsd.edu:1094 dtn-f019-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f019-06.t2.ucsd.edu:1094 dtn-f019-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f019-07.t2.ucsd.edu:1094 dtn-f019-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f019-08.t2.ucsd.edu:1094 dtn-f019-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f01a
    bind 2001:48d0:6020:f01a::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f01a)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f01a
        mode http
        option tcp-check
        server dtn-f01a-02.t2.ucsd.edu:1094 dtn-f01a-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01a-03.t2.ucsd.edu:1094 dtn-f01a-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01a-04.t2.ucsd.edu:1094 dtn-f01a-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01a-05.t2.ucsd.edu:1094 dtn-f01a-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01a-06.t2.ucsd.edu:1094 dtn-f01a-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01a-07.t2.ucsd.edu:1094 dtn-f01a-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01a-08.t2.ucsd.edu:1094 dtn-f01a-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f01b
    bind 2001:48d0:6020:f01b::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f01b)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f01b
        mode http
        option tcp-check
        server dtn-f01b-02.t2.ucsd.edu:1094 dtn-f01b-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01b-03.t2.ucsd.edu:1094 dtn-f01b-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01b-04.t2.ucsd.edu:1094 dtn-f01b-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01b-05.t2.ucsd.edu:1094 dtn-f01b-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01b-06.t2.ucsd.edu:1094 dtn-f01b-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01b-07.t2.ucsd.edu:1094 dtn-f01b-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01b-08.t2.ucsd.edu:1094 dtn-f01b-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f01c
    bind 2001:48d0:6020:f01c::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f01c)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f01c
        mode http
        option tcp-check
        server dtn-f01c-02.t2.ucsd.edu:1094 dtn-f01c-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01c-03.t2.ucsd.edu:1094 dtn-f01c-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01c-04.t2.ucsd.edu:1094 dtn-f01c-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01c-05.t2.ucsd.edu:1094 dtn-f01c-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01c-06.t2.ucsd.edu:1094 dtn-f01c-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01c-07.t2.ucsd.edu:1094 dtn-f01c-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01c-08.t2.ucsd.edu:1094 dtn-f01c-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f01d
    bind 2001:48d0:6020:f01d::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f01d)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f01d
        mode http
        option tcp-check
        server dtn-f01d-02.t2.ucsd.edu:1094 dtn-f01d-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01d-03.t2.ucsd.edu:1094 dtn-f01d-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01d-04.t2.ucsd.edu:1094 dtn-f01d-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01d-05.t2.ucsd.edu:1094 dtn-f01d-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01d-06.t2.ucsd.edu:1094 dtn-f01d-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01d-07.t2.ucsd.edu:1094 dtn-f01d-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01d-08.t2.ucsd.edu:1094 dtn-f01d-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f01e
    bind 2001:48d0:6020:f01e::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f01e)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f01e
        mode http
        option tcp-check
        server dtn-f01e-02.t2.ucsd.edu:1094 dtn-f01e-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01e-03.t2.ucsd.edu:1094 dtn-f01e-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01e-04.t2.ucsd.edu:1094 dtn-f01e-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01e-05.t2.ucsd.edu:1094 dtn-f01e-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01e-06.t2.ucsd.edu:1094 dtn-f01e-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01e-07.t2.ucsd.edu:1094 dtn-f01e-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01e-08.t2.ucsd.edu:1094 dtn-f01e-08.t2.ucsd.edu:1094  check ssl verify none

frontend range-f01f
    bind 2001:48d0:6020:f01f::900:1094 ssl crt /usr/local/etc/haproxy/certs/cert.pem
    mode http
    option httplog

    http-request set-var(req.backend_name) str(backendrange-f01f)
    http-request lua.random_redirect

    # Set prefix if token is found
    http-request set-var(req.redirect_prefix) str(?authz=) if { var(req.auth_token) -m found } !{ query -m found }
    http-request set-var(req.redirect_prefix) str(&authz=) if { var(req.auth_token) -m found } { query -m found }

    http-request redirect location https://%[var(req.target_host)]%[path]%[query]%[var(req.redirect_prefix)]%[var(req.auth_token)] code 307 if { var(req.target_host) -m found }


backend backendrange-f01f
        mode http
        option tcp-check
        server dtn-f01f-02.t2.ucsd.edu:1094 dtn-f01f-02.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01f-03.t2.ucsd.edu:1094 dtn-f01f-03.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01f-04.t2.ucsd.edu:1094 dtn-f01f-04.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01f-05.t2.ucsd.edu:1094 dtn-f01f-05.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01f-06.t2.ucsd.edu:1094 dtn-f01f-06.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01f-07.t2.ucsd.edu:1094 dtn-f01f-07.t2.ucsd.edu:1094  check ssl verify none
        server dtn-f01f-08.t2.ucsd.edu:1094 dtn-f01f-08.t2.ucsd.edu:1094  check ssl verify none
